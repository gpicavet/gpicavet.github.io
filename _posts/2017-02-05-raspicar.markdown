---
layout: post
title:  "RaspiCAR : a robot car with Raspberry and Legos - part I"
date:   2017-02-11 22:05:11 +0200
categories: jekyll update
---

<link href='//netdna.bootstrapcdn.com/bootstrap/3.0.0/css/bootstrap.min.css' rel='stylesheet'>
<style>

.carousel {
margin-bottom: 0;
padding: 0 40px 30px 40px;
}

.carousel-control {
left: -12px;
height: 40px;
width: 40px;
background: none repeat scroll 0 0 #222222;
border: 4px solid #FFFFFF;
border-radius: 23px 23px 23px 23px;
margin-top: 90px;
}
.carousel-control.right {
right: -12px;
}

.carousel-indicators {
right: 50%;
top: auto;
bottom: -10px;
margin-right: -19px;
}

.carousel-indicators li {
background: #cecece;
}

.carousel-indicators .active {
background: #428bca;
}
</style>
<script type='text/javascript' src='//code.jquery.com/jquery-1.10.2.min.js'></script>
<script type='text/javascript' src='//netdna.bootstrapcdn.com/bootstrap/3.0.0/js/bootstrap.min.js'></script>
<script type='text/javascript'>$(document).ready(function() {
$('#Carousel').carousel({
interval: 5000
})
$('#Carousel2').carousel({
interval: 5000
})
});
</script>

<h2>
I always wanted to build a robot car, just for fun, not to eradicate human race :) <br>
The first step consisted in integrating the base components and providing manual control.
</h2>

<div class="container">
<div class="row">
<div class="col-md-12">
<div id="Carousel" class="carousel slide">

<ol class="carousel-indicators">
<li data-target="#Carousel" data-slide-to="0" class="active"></li>
<li data-target="#Carousel" data-slide-to="1"></li>
<li data-target="#Carousel" data-slide-to="2"></li>
</ol>

<!-- Carousel items -->
<div class="carousel-inner">

<div class="item active">
<div class="row">
<div class="col-md-12"><a href="#" class="thumbnail"><img src="/assets/raspicar/photo_1.jpg" alt="Image" style="max-width:100%;"></a></div>
</div><!--.row-->
</div><!--.item-->

<div class="item">
<div class="row">
<div class="col-md-12"><a href="#" class="thumbnail"><img src="/assets/raspicar/photo_2.jpg" alt="Image" style="max-width:100%;"></a></div>
</div><!--.row-->
</div><!--.item-->

<div class="item">
<div class="row">
<div class="col-md-12"><a href="#" class="thumbnail"><img src="/assets/raspicar/photo_3.jpg" alt="Image" style="max-width:100%;"></a></div>
</div><!--.row-->
</div><!--.item-->

</div><!--.carousel-inner-->
<a data-slide="prev" href="#Carousel" class="left carousel-control">‹</a>
<a data-slide="next" href="#Carousel" class="right carousel-control">›</a>
</div><!--.Carousel-->

</div>
</div>
</div><!--.container-->

## a small video !

<center>
<iframe id="ytplayer" type="text/html"
  src="https://www.youtube.com/embed/vF_nzevWZAE?autoplay=0&origin=https://gpicavet.github.io"
  frameborder="0"></iframe>
</center>

# Hardware Part

## Components

The components i used in this project. The overall costed nearly 150 € .

<div class="container">
<div class="row">
<div class="col-md-12">
<div id="Carousel2" class="carousel slide">

<ol class="carousel-indicators">
<li data-target="#Carousel2" data-slide-to="0" class="active"></li>
<li data-target="#Carousel2" data-slide-to="1"></li>
<li data-target="#Carousel2" data-slide-to="2"></li>
</ol>

<!-- Carousel items -->
<div class="carousel-inner"  style="min-height:300px">

<div class="item active">
<div class="row">
<div class="col-md-6"><a href="#" class="thumbnail"><img src="/assets/raspicar/pi3.jpg" alt="Image" style="max-width:100%;"></a>Raspberry Pi 3</div>
<div class="col-md-6"><a href="#" class="thumbnail"><img src="/assets/raspicar/arduino-uno.jpeg" alt="Image" style="max-width:100%;"></a>Arduino Uno</div>
</div><!--.row-->
</div><!--.item-->

<div class="item">
<div class="row">
<div class="col-md-6"><a href="#" class="thumbnail"><img src="/assets/raspicar/motor.jpg" alt="Image" style="max-width:100%;"></a>Nema stepper motor 11HS18-0674S (X2)</div>
<div class="col-md-6"><a href="#" class="thumbnail"><img src="/assets/raspicar/drv8834.jpeg" alt="Image" style="max-width:100%;"></a>stepper driver Polulu DRV8834 (X2)</div>
</div><!--.item-->
</div><!--.row-->

<div class="item">
<div class="row">
<div class="col-md-6"><a href="#" class="thumbnail"><img src="/assets/raspicar/coupler.jpg" alt="Image" style="max-width:100%;"></a>Axis Coupler (X2)</div>
<div class="col-md-6"><a href="#" class="thumbnail"><img src="/assets/raspicar/capa.jpg" alt="Image" style="max-width:100%;"></a>100µF Capacitor (X2)</div>
</div><!--.row-->
</div><!--.item-->

<div class="item">
<div class="row">
<div class="col-md-6"><a href="#" class="thumbnail"><img src="/assets/raspicar/battery.jpg" alt="Image" style="max-width:100%;"></a>10000mAh Li-Ion USB Battery</div>
<div class="col-md-6"><a href="#" class="thumbnail"><img src="/assets/raspicar/jumpers.jpeg" alt="Image" style="max-width:100%;"></a>Jumper wirers</div>
</div><!--.row-->
</div><!--.item-->

<div class="item">
<div class="row">
<div class="col-md-6"><a href="#" class="thumbnail"><img src="/assets/raspicar/breadboard.jpeg" alt="Image" style="max-width:100%;"></a>Mini Breadboard (X2)</div>
<div class="col-md-6"><a href="#" class="thumbnail"><img src="/assets/raspicar/webcam.jpeg" alt="Image" style="max-width:100%;"></a>An USB cam</div>
</div><!--.row-->
</div><!--.item-->

<div class="item">
<div class="row">
<div class="col-md-6"><a href="#" class="thumbnail"><img src="/assets/raspicar/legos.jpg" alt="Image" style="max-width:100%;"></a>And Legos of course !</div>
</div><!--.row-->
</div><!--.item-->

</div><!--.carousel-inner-->
<a data-slide="prev" href="#Carousel2" class="left carousel-control">‹</a>
<a data-slide="next" href="#Carousel2" class="right carousel-control">›</a>
</div><!--.Carousel-->

</div>
</div>
</div><!--.container-->


## Schema
![Schema](/assets/raspicar/raspicar_v1_bb.png)

## Motors and drivers
- I used two Nema Bipolar Stepper motors because i needed precision and high couple (see weight!).
- Each Stepper Motor is controled with a DRV8834 stepper board in order to simplify the arduino code and to safely limit current.
- I tweaked the limit current as described on the Pololu Site, using Vref = Imax / 2. As Nema max current is 670mA, Vref of the driver should be 335mV. From now i can provide higher voltage to motors without damage.

## Weight
- Raspi Car weights 1200g . That is one beautiful baby :)

# Software Part

## Arduino Side
- Arduino Job consists in listening to commands on the USB port and drive the steering and propulsion motors
- There are several ways to implement Arduino/Raspberry communication
- The program is built and uploaded to Arduino with the IDE.

## Raspberry Side
- Raspberry Job consists in providing a Wifi communication, a web interface, and video streaming.

### Web UI & communication layer
- Web UI relies on Flask python Library on server-side, and jquery/ui on client-side
- client and server communication rely on WebSocket and Flask-socketio library with Eventlet engine
- python3 and flask are already bundled with raspbian distribution. But you need to manually install the socketio and eventlet  :
{% highlight shell %}
sudo pip3 install flask-socketio
sudo pip3 install eventlet
{% endhighlight %}



### video streaming
- I first tried ffmpeg and motion libraries but delay was too high (> 500ms).
- I ended up using mjpeg streamer as decribed in this nice article <https://jacobsalmela.com/2014/05/31/raspberry-pi-webcam-using-mjpg-streamer-over-internet/>.
It's more image capture than video streaming but framerate is good enough (5 to 10 fps) and delay is much better (100ms).

## source code & deploy
- <https://github.com/gpicavet/raspicar>
- deploy car.uno to Arduino
- Then on Raspberry you have to start ./start_mjpeg.sh and ./raspicar.py 


## what's next ?
Next Part is really Challenging : take the full power of the raspberry "brain" and make the car smarter :).
